name: build-draft-release

on: workflow_dispatch

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_PAT }}

jobs:
  build-tauri:
    name: Build Tauri ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            artifact-name: windows-binary
            upload-path: |
              src-tauri/target/release/bitrot.exe
              src-tauri/target/release/bundle/msi/*.msi
              src-tauri/target/release/bundle/nsis/*.exe
          - os: ubuntu-latest
            artifact-name: linux-binary
            upload-path: |
              src-tauri/target/release/bitrot
              src-tauri/target/release/bundle/deb/*.deb
              src-tauri/target/release/bundle/rpm/*.rpm
              src-tauri/target/release/bundle/appimage/*.AppImage
          - os: macos-latest
            artifact-name: macos-binary
            upload-path: |
              src-tauri/target/release/bitrot
              src-tauri/target/release/bundle/dmg/*.dmg
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Install Linux system dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            ffmpeg
      - name: Install FFmpeg (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install ffmpeg --no-progress
      - name: Install FFmpeg (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install ffmpeg
      - name: Setup ffmpeg sidecars
        run: pnpm run setup:ffmpeg
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
      - name: Build Tauri app
        run: pnpm tauri build
      - name: Upload ${{ matrix.os }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.upload-path }}

  create-draft-release:
    name: Create Draft Release
    needs: build-tauri
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Compute release tag from root package.json
        id: tag
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [ -z "$VERSION" ]; then
            echo "Could not read .version from root package.json" >&2
            exit 1
          fi
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Create/Update draft release and upload assets
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --draft --title "Bitrot build $TAG"
          else
            gh release create "$TAG" --draft --title "Bitrot build $TAG" --target "${GITHUB_SHA}"
          fi
          mapfile -d '' FILES < <(
            find artifacts -type f \
              \( -iname '*.msi' -o -iname '*.exe' -o -iname '*.dmg' \
                 -o -iname '*.zip' -o -iname '*.deb' -o -iname '*.rpm' -o -iname '*.AppImage' \) \
              -print0
          )
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No release files found under artifacts/" >&2
            find artifacts -maxdepth 3 -type d -print
            exit 1
          fi
          gh release upload "$TAG" "${FILES[@]}" --clobber

name: build-draft-release

on: workflow_dispatch

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GH_PAT }}

jobs:
  build-tauri:
    name: Build Tauri ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            artifact-name: windows-bundles
            upload-path: |
              src-tauri/target/release/bundle/msi/*.msi
              src-tauri/target/release/bundle/nsis/*.exe
          - os: ubuntu-latest
            artifact-name: linux-bundles
            upload-path: |
              src-tauri/target/release/bundle/appimage/*.AppImage
          - os: macos-latest
            artifact-name: macos-unbundled
            upload-path: |
              src-tauri/target/release/bitrot-macos-unbundled.tar.gz
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Install Linux system dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            ffmpeg
      - name: Install FFmpeg (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install ffmpeg --no-progress
      - name: Install FFmpeg (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install ffmpeg
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
      - name: Setup ffmpeg sidecars (Windows)
        if: matrix.os == 'windows-latest'
        run: pnpm run setup:ffmpeg
        env:
          FFMPEG_BIN: C:\ProgramData\chocolatey\lib\ffmpeg\tools\ffmpeg.exe
          FFPROBE_BIN: C:\ProgramData\chocolatey\lib\ffmpeg\tools\ffprobe.exe
      - name: Setup ffmpeg sidecars (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: pnpm run setup:ffmpeg
      - name: Setup ffmpeg sidecars (macOS)
        if: matrix.os == 'macos-latest'
        run: pnpm run setup:ffmpeg
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
      - name: Build Windows app (no bundle)
        if: matrix.os == 'windows-latest'
        run: pnpm tauri build --no-bundle
      - name: Package Windows unbundled exe
        if: matrix.os == 'windows-latest'
        run: |
          New-Item -ItemType Directory -Force -Path src-tauri/target/release/unbundled | Out-Null
          Copy-Item -Force src-tauri/target/release/bitrot.exe src-tauri/target/release/unbundled/bitrot.exe
          Compress-Archive -Path src-tauri/target/release/unbundled/* -DestinationPath src-tauri/target/release/bitrot-windows-unbundled.zip -Force
      - name: Build Windows bundles
        if: matrix.os == 'windows-latest'
        run: pnpm tauri build --bundles msi,nsis
      - name: Package Windows bundled exe
        if: matrix.os == 'windows-latest'
        run: |
          New-Item -ItemType Directory -Force -Path src-tauri/target/release/bundled/binaries | Out-Null
          Copy-Item -Force src-tauri/target/release/bitrot.exe src-tauri/target/release/bundled/bitrot-bundled.exe
          Copy-Item -Force src-tauri/binaries/ffmpeg.exe src-tauri/target/release/bundled/binaries/ffmpeg.exe
          Copy-Item -Force src-tauri/binaries/ffprobe.exe src-tauri/target/release/bundled/binaries/ffprobe.exe
          Compress-Archive -Path src-tauri/target/release/bundled/* -DestinationPath src-tauri/target/release/bitrot-windows-bundled.zip -Force
      - name: Build macOS app (no bundle)
        if: matrix.os == 'macos-latest'
        run: pnpm tauri build --no-bundle
      - name: Package macOS unbundled binary
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p src-tauri/target/release/unbundled
          cp src-tauri/target/release/bitrot src-tauri/target/release/unbundled/bitrot
          tar -czf src-tauri/target/release/bitrot-macos-unbundled.tar.gz -C src-tauri/target/release/unbundled bitrot
      - name: Build macOS bundles (best effort)
        if: matrix.os == 'macos-latest'
        id: macos_bundle
        continue-on-error: true
        run: pnpm tauri build --bundles dmg
      - name: Upload macOS bundled artifact (best effort)
        if: matrix.os == 'macos-latest' && steps.macos_bundle.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: macos-bundled
          path: src-tauri/target/release/bundle/dmg/*.dmg
      - name: Build Linux app (no bundle)
        if: matrix.os == 'ubuntu-latest'
        run: pnpm tauri build --no-bundle
      - name: Package Linux unbundled binary
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p src-tauri/target/release/unbundled
          cp src-tauri/target/release/bitrot src-tauri/target/release/unbundled/bitrot
          tar -czf src-tauri/target/release/bitrot-linux-unbundled.tar.gz -C src-tauri/target/release/unbundled bitrot
      - name: Build Linux bundles
        if: matrix.os == 'ubuntu-latest'
        run: pnpm tauri build --bundles appimage
      - name: Upload ${{ matrix.os }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.upload-path }}
      - name: Upload Windows unbundled artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-unbundled
          path: src-tauri/target/release/bitrot-windows-unbundled.zip
      - name: Upload Windows bundled artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundled
          path: src-tauri/target/release/bitrot-windows-bundled.zip
      - name: Upload Linux unbundled artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-unbundled
          path: src-tauri/target/release/bitrot-linux-unbundled.tar.gz

  create-draft-release:
    name: Create Draft Release
    needs: build-tauri
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Normalize artifact filenames to lowercase
        run: |
          shopt -s globstar
          for path in artifacts/**/*; do
            [ -f "$path" ] || continue
            dir=$(dirname "$path")
            base=$(basename "$path")
            lower=$(echo "$base" | tr '[:upper:]' '[:lower:]')
            if [ "$base" != "$lower" ]; then
              if [ -e "$dir/$lower" ]; then
                echo "Filename collision when lowercasing: $dir/$lower" >&2
                exit 1
              fi
              mv "$path" "$dir/$lower"
            fi
          done
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Compute release tag from root package.json
        id: tag
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [ -z "$VERSION" ]; then
            echo "Could not read .version from root package.json" >&2
            exit 1
          fi
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Write draft release notes
        run: |
          cat <<'EOF' > release-notes.txt
          ## Bundled vs unbundled

          - **Bundled** assets include ffmpeg/ffprobe sidecars inside the package.
          - **Unbundled** assets include only Bitrot and require ffmpeg/ffprobe on PATH or placed next to the binary.

          ## Bundled assets

          - Windows installers: `*.msi`, `*-setup.exe`
          - Windows bundled exe: `bitrot-windows-bundled.zip`
          - Linux AppImage: `*.appimage` (requires GTK/WebKit runtime deps)

          ## Unbundled assets

          - Windows: `bitrot-windows-unbundled.zip`
          - macOS: `bitrot-macos-unbundled.tar.gz` (macOS currently ships unbundled only)
          - Linux: `bitrot-linux-unbundled.tar.gz` (requires GTK/WebKit runtime deps)

          ## Runtime notes

          BitRot resolves FFmpeg in this order: local binary next to the app, bundled sidecars, then system PATH.
          EOF
      - name: Create/Update draft release and upload assets
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --draft --title "Bitrot build $TAG" --notes-file release-notes.txt
          else
            gh release create "$TAG" --draft --title "Bitrot build $TAG" --notes-file release-notes.txt --target "${GITHUB_SHA}"
          fi
          mapfile -d '' FILES < <(
            find artifacts -type f \
              \( -iname '*.msi' -o -iname '*.exe' \
                 -o -iname '*.zip' -o -iname '*.tar.gz' -o -iname '*.deb' -o -iname '*.rpm' -o -iname '*.appimage' \) \
              -print0
          )
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No release files found under artifacts/" >&2
            find artifacts -maxdepth 3 -type d -print
            exit 1
          fi
          gh release upload "$TAG" "${FILES[@]}" --clobber
